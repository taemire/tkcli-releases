name: Update Issue Backlog

on:
  issues:
    types: [opened, reopened, closed, deleted, edited]
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: update-backlog
  cancel-in-progress: true

jobs:
  update-doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Process Issues and Update Backlog
        env:
          GH_TOKEN: ${{ github.token }}
          DOC_FILE: "docs/ISSUE_BACKLOG.md"
        run: |
          # 1. ë¬¸ì„œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì´ˆê¸°í™”
          mkdir -p docs
          if [ ! -f "$DOC_FILE" ]; then
            cat > "$DOC_FILE" << 'INIT'
          # ğŸš€ tkcli ì´ìŠˆ ë°±ë¡œê·¸ (Auto-Synced)

          <!-- START_ISSUES_LIST -->
          <!-- END_ISSUES_LIST -->
          INIT
          fi

          # 2. Python ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat << 'PYEOF' > update_script.py
          import subprocess
          import json
          import re
          import os

          def get_issues():
              """gh CLIë¥¼ í†µí•´ Open ì´ìŠˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"""
              cmd = [
                  "gh", "issue", "list",
                  "--state", "open",
                  "--limit", "100",
                  "--json", "number,title,author,url,body"
              ]
              result = subprocess.run(cmd, capture_output=True, text=True)
              if result.returncode != 0:
                  print(f"âš ï¸ gh issue list failed: {result.stderr}")
                  return []
              return json.loads(result.stdout)

          def process_issues(issues):
              """ì´ìŠˆ ë°ì´í„°ë¥¼ ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸”ë¡œ ë³€í™˜"""
              content = "| No. | Title | Summary | Images | Link |\n"
              content += "| :---: | --- | --- | --- | :---: |\n"

              if not issues:
                  content += "| - | í˜„ì¬ ì—´ë ¤ ìˆëŠ” ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤ | - | - | - |\n"
                  return content

              img_pattern = re.compile(r'!\[.*?\]\((.*?)\)')

              for issue in issues:
                  number = issue['number']
                  title = issue['title'].replace('|', '-')
                  url = issue['url']
                  body = issue.get('body') or ""

                  # ë³¸ë¬¸ ìš”ì•½ (ì´ë¯¸ì§€ íƒœê·¸ ì œê±° í›„ 80ì ì œí•œ)
                  summary = body.replace('\r', '').replace('\n', ' ')
                  summary = re.sub(r'<img[^>]*>', '', summary)
                  summary = re.sub(r'!\[.*?\]\(.*?\)', '', summary)
                  summary = re.sub(r' +', ' ', summary).strip()
                  if len(summary) > 80:
                      summary = summary[:80] + "..."
                  summary = summary.replace('|', '-')

                  # ì´ë¯¸ì§€ ì¶”ì¶œ (Markdown + HTML img íƒœê·¸)
                  md_images = img_pattern.findall(body)
                  html_images = re.findall(r'<img[^>]+src=["\']([^"\']+)["\']', body)
                  images = md_images + html_images

                  image_cell = "-"
                  if images:
                      links = [f"[Img{i+1}]({link})" for i, link in enumerate(images)]
                      image_cell = ", ".join(links)

                  content += f"| #{number} | {title} | {summary} | {image_cell} | [Link]({url}) |\n"

              return content

          def update_file(new_content, file_path):
              """ë§ˆì»¤ ì‚¬ì´ì˜ ë‚´ìš©ë§Œ êµì²´"""
              with open(file_path, 'r', encoding='utf-8') as f:
                  original_content = f.read()

              pattern = re.compile(
                  r'(<!-- START_ISSUES_LIST -->)(.*?)(<!-- END_ISSUES_LIST -->)',
                  re.DOTALL
              )

              if pattern.search(original_content):
                  updated_content = pattern.sub(
                      rf'\1\n{new_content}\3',
                      original_content
                  )
                  with open(file_path, 'w', encoding='utf-8') as f:
                      f.write(updated_content)
                  print("âœ… Document updated successfully.")
              else:
                  print("âš ï¸ Markers not found in the document.")

          if __name__ == "__main__":
              issues = get_issues()
              print(f"Found {len(issues)} open issue(s)")
              table_content = process_issues(issues)
              update_file(table_content, os.environ['DOC_FILE'])
          PYEOF

          # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python3 update_script.py

      - name: Commit and Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [[ -n $(git status -s docs/ISSUE_BACKLOG.md) ]]; then
            git add docs/ISSUE_BACKLOG.md
            git commit -m "docs: ì´ìŠˆ ë°±ë¡œê·¸ ìë™ ê°±ì‹  [skip ci]"
            git push
            echo "ğŸš€ Changes pushed to repository."
          else
            echo "ğŸ‘ No changes to commit."
          fi
