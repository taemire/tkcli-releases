## 3.6 보안 진단 및 조치 (Security Analysis & Remediation)

`tkcli`는 OS, Web(Nginx 등), DB(MariaDB) 전 영역에 대한 통합 보안 취약점 진단(`analyze`) 기능과, 발견된 취약점에 대한 자동화된 조치(`fix`) 기능을 제공합니다.

---

### 3.6.1 보안 진단 (Analyze Security)

시스템의 현재 설정 상태를 KISA 주요정보통신기반시설 취약점 분석 기준에 따라 점검하고 리포트를 생성합니다.

### 사용법
```bash
tkcli analyze security [flags]
```

### 주요 플래그
| 플래그 | 설명 | 기본값 |
|:---|:---|:---|
| `--target`, `-t` | 점검 대상 지정 (`os`, `web`, `db`, `all`) | `all` |
| `--format`, `-f` | 리포트 포맷 지정 (`json`, `html`) | `json` |
| `--output`, `-o` | 결과 파일 저장 경로 | 자동 생성 |
| `--quiet`, `-q` | 콘솔 출력 억제 (자동화 스크립트용) | `false` |

### 사용 예시

**1. 전체 시스템 정밀 진단 후 HTML 리포트 생성**
```bash
tkcli analyze security --format html
# 실행 결과: tkcli-security-report-20260118-143000.html 생성됨
```
생성된 HTML 파일을 브라우저로 열면, 색상 코드로 구분된 직관적인 점검 결과를 확인할 수 있습니다.

**2. OS 설정만 빠르게 점검**
```bash
tkcli analyze security -t os
```

**3. CI/CD 파이프라인 연동 (JSON 출력)**
```bash
tkcli analyze security --format json --quiet
# 실행 결과: tkcli-security-report-YYYYMMDD-HHMMSS.json 생성됨 (로그 없음)
```

---

### 3.6.2 보안 조치 (Fix Security)

진단 결과 발견된 '취약(Vulnerable)' 항목에 대해 자동으로 설정을 수정하여 보안성을 강화합니다.

> **⚠️ 주의**: 보안 조치는 시스템 설정을 직접 변경하므로, 반드시 백업을 수행하고(`--backup=true`), `--dry-run` 모드로 변경 내용을 미리 확인하는 것을 권장합니다.

### 사용법
```bash
tkcli fix security [flags]
```

### 주요 플래그
| 플래그 | 설명 | 기본값 |
|:---|:---|:---|
| `--id` | 조치할 특정 취약점 ID (예: `U-01`) | **필수** (단, `--report`, `--all` 사용 시 제외) |
| `--report` | 분석 리포트(JSON) 기반 자동 조치 | `""` |
| `--all` | 지원하는 모든 항목 일괄 조치 (주의 필요) | `false` |
| `--dry-run` | 실제 변경 없이 조치 내용 시뮬레이션 | `false` |
| `--backup` | 조치 전 원본 설정 파일 백업 수행 | `true` |
| `--interactive`, `-i` | 각 조치 항목별 확인을 요청하는 대화형 모드 | `false` |

### 사용 예시

**1. 특정 취약점(U-01) 조치 전 시뮬레이션 (Dry-run)**
```bash
tkcli fix security --id U-01 --dry-run
# 실행 결과:
# [INFO] 보안 조치(Remediation) 프로세스 시작
# [INFO] [U-01] 조치 시작: SSH 설정 파일(sshd_config)에서 PermitRootLogin을 'no'로 설정하고 서비스를 재시작합니다.
# [INFO]   [DryRun] 실제 변경은 수행되지 않습니다.
# [SUCC] 모든 조치 프로세스가 완료되었습니다.
```

**2. 특정 취약점(U-01) 실제 조치**
```bash
tkcli fix security --id U-01
# 실행 결과:
# [INFO] [U-01] 조치 시작: SSH 설정 파일(sshd_config)에서 PermitRootLogin을 'no'로 설정하고 서비스를 재시작합니다.
# [SUCC]   백업 완료: /etc/ssh/sshd_config.bak_20260118_194500
# [SUCC]   조치 완료
```

**3. 리포트 기반 일괄 조치 (`--report`)**

진단 결과(`tkcli analyze --format json`)를 기반으로, 취약한(`VULNERABLE`) 항목만 선별하여 조치합니다.

```bash
tkcli fix security --report tkcli-security-report-20260118.json
# 실행 결과:
# [INFO] 리포트 분석 중: tkcli-security-report-20260118.json
# 발견된 취약점: 15건 | 자동 조치 가능: 3건
# ... (이후 조치 프로세스 진행)
```

**4. 대화형 모드로 조치 (`--interactive`)**

각 항목을 조치하기 전 사용자 확인을 요청합니다. 옵션: `y`(Yes), `n`(No/Skip), `a`(All/이후 전부 Yes), `q`(Quit/중단)

```bash
tkcli fix security --all --interactive
# 실행 결과:
# [INFO] 총 85건의 조치 항목이 선택되었습니다.
# ----------------------------------------------------------------
# [INFO] [U-01] 조치 대상: Root 계정 원격 접속 제한 (SSH PermitRootLogin 설정)
# [U-01] 항목을 조치하시겠습니까? [y(Yes)/n(No)/a(All)/q(Quit)]: y
# [INFO]   -> 조치를 시작합니다...
# [SUCC]   백업 완료: /etc/ssh/sshd_config.bak_20260119_143000
# [SUCC]   조치 완료
# ...
```

### 3.6.3 지원하는 점검/조치 항목

`tkcli`는 KISA 주요정보통신기반시설 기술적 취약점 분석 평가 상세 가이드를 준수하여 아래 항목들을 진단합니다.

#### 3.6.3.1 Linux OS

> **✅ 전체 73개 항목 조치 지원 (v0.4.17)**
> - **자동 조치 (Type A)**: U-01~U-04, U-07~U-12, U-15, U-18~U-23, U-28~U-30, U-32, U-37, U-39
> - **수동 가이드 (Type C)**: 나머지 항목 - 상세 명령어 및 가이드 출력

| ID | 분류 | 항목명 | 상세 설명 | 진단 | 조치 |
|:---:|:---:|:---|:---|:---:|:---:|
| U-01 | 계정 관리 | Root 원격 접속 제한 | SSH/Telnet Root 직접 접속 허용 여부 (`PermitRootLogin no`) | ✅ | ✅ |
| U-02 | 계정 관리 | 패스워드 복잡성 설정 | 영문/숫자/특수문자 조합 및 길이 강제 설정 | ✅ | ✅ |
| U-03 | 계정 관리 | 계정 잠금 임계값 설정 | 로그인 실패 시 계정 잠금 (`deny=5`) | ✅ | ✅ |
| U-04 | 계정 관리 | 패스워드 파일 보호 | 패스워드 암호화 및 Shadow 파일 사용 여부 | ✅ | ✅ |
| U-05 | 계정 관리 | Root 이외의 UID 0 금지 | UID 0을 가진 비인가 계정 존재 여부 | ✅ | ✅ |
| U-06 | 파일 권한 | root 홈/패스 권한 | `su` 명령어 그룹 제한 및 권한 점검 | ✅ | ✅ |
| U-07 | 계정 관리 | 패스워드 최소 길이 | 패스워드 최소 길이(8자 이상) 설정 | ✅ | ✅ |
| U-08 | 계정 관리 | 패스워드 최대 사용기간 | 패스워드 최대 사용 기간(90일) 설정 | ✅ | ✅ |
| U-09 | 계정 관리 | 패스워드 최소 사용기간 | 패스워드 최소 사용 기간(1일) 설정 | ✅ | ✅ |
| U-10 | 계정 관리 | 불필요한 계정 제거 | 불필요한 시스템 계정 존재 여부 | ✅ | ✅ |
| U-11 | 계정 관리 | 관리자 그룹 사용자 관리 | 관리자 그룹(root)에 불필요한 계정 등록 여부 | ✅ | ✅ |
| U-12 | 계정 관리 | 계정이 없는 그룹 관리 | 소유자 없는 그룹(GID) 존재 여부 | ✅ | ✅ |
| U-13 | 계정 관리 | 동일한 UID 금지 | 동일한 UID를 사용하는 중복 계정 존재 여부 | ✅ | ✅ |
| U-14 | 계정 관리 | 사용자 Shell 점검 | 로그인이 불필요한 계정에 Shell 부여 여부 | ✅ | ✅ |
| U-15 | 계정 관리 | Session Timeout 설정 | 유휴 세션 타임아웃 설정 (600초) | ✅ | ✅ |
| U-16 | 파일 권한 | Root 홈/패스 설정 | PATH 환경변수에 '.' 포함 여부 | ✅ | ✅ |
| U-17 | 파일 권한 | 파일/디렉터리 소유자 | 소유자(User/Group)가 없는 파일 존재 여부 | ✅ | ✅ |
| U-18 | 파일 권한 | /etc/passwd 파일 | 소유자(root) 및 권한(644) 점검 | ✅ | ✅ |
| U-19 | 파일 권한 | /etc/shadow 파일 | 소유자(root) 및 권한(400) 점검 | ✅ | ✅ |
| U-20 | 파일 권한 | /etc/hosts 파일 | 소유자(root) 및 권한(600) 점검 | ✅ | ✅ |
| U-21 | 파일 권한 | /etc/(x)inetd.conf | 소유자(root) 및 권한(600) 점검 | ✅ | ✅ |
| U-22 | 파일 권한 | /etc/syslog.conf | 소유자(root) 및 권한(644) 점검 | ✅ | ✅ |
| U-23 | 파일 권한 | /etc/services 파일 | 소유자(root) 및 권한(644) 점검 | ✅ | ✅ |
| U-24 | 파일 권한 | SUID/SGID 설정 | 주요 파일의 SUID/SGID 설정 여부 | ✅ | ✅ |
| U-25 | 파일 권한 | 사용자 환경 파일 | 사용자 홈 환경파일 소유자/권한 점검 | ✅ | ✅ |
| U-26 | 파일 권한 | World Writable 파일 | 누구나 쓸 수 있는 파일 존재 여부 | ✅ | ✅ |
| U-27 | 파일 권한 | /dev 디바이스 파일 | /dev 내 존재하지 않는 디바이스 파일 점검 | ✅ | ✅ |
| U-28 | 서비스 관리 | .rhosts/hosts.equiv | r-command 인증 파일 사용 여부 및 권한 | ✅ | ✅ |
| U-29 | 서비스 관리 | 접속 IP/Port 제한 | TCP Wrapper(hosts.allow/deny) 접근 제어 | ✅ | ✅ |
| U-30 | 서비스 관리 | hosts.lpd 파일 | 프린터 서비스 접근 제어 파일 소유자/권한 | ✅ | ✅ |
| U-31 | 서비스 관리 | NIS 서비스 비활성화 | NIS 서비스 활성화 여부 | ✅ | ✅ |
| U-32 | 서비스 관리 | UMASK 설정 | 시스템 기본 UMASK(022) 설정 여부 | ✅ | ✅ |
| U-33 | 서비스 관리 | 홈 디렉터리 권한 | 홈 디렉터리 소유자 및 권한(750) 설정 | ✅ | ✅ |
| U-34 | 서비스 관리 | 홈 디렉터리 존재 | 계정별 홈 디렉터리 존재 여부 | ✅ | ✅ |
| U-35 | 서비스 관리 | 숨겨진 파일 탐색 | 디렉터리 내 불필요한 숨겨진 파일 점검 | ✅ | ✅ |
| U-36 | 서비스 관리 | Finger 서비스 | Finger 서비스 활성화 여부 | ✅ | ✅ |
| U-37 | 서비스 관리 | Anonymous FTP | 익명 FTP 접속 허용 여부 | ✅ | ✅ |
| U-38 | 서비스 관리 | r 계열 서비스 | rlogin, rsh, rexec 등 취약 서비스 활성화 | ✅ | ✅ |
| U-39 | 서비스 관리 | Cron 파일 권한 | cron 접근 제어 파일(allow/deny) 권한 | ✅ | ✅ |
| U-40 | 서비스 관리 | DoS 공격 취약 서비스 | echo, discard 등 DoS 취약 서비스 활성화 | ✅ | ✅ |
| U-41 | 서비스 관리 | NFS 서비스 비활성화 | 불필요한 NFS 서비스 활성화 여부 | ✅ | ✅ |
| U-42 | 서비스 관리 | NFS 접근 통제 | NFS 공유 디렉터리 접근 제어(exports) | ✅ | ✅ |
| U-43 | 서비스 관리 | automountd 제거 | automountd 서비스 활성화 여부 | ✅ | ✅ |
| U-44 | 서비스 관리 | RPC 서비스 확인 | 불필요한 RPC 서비스 활성화 여부 | ✅ | ✅ |
| U-45 | 서비스 관리 | NIS, NIS+ 점검 | NIS/NIS+ 서비스 활성화 여부 | ✅ | ✅ |
| U-46 | 서비스 관리 | tftp, talk 서비스 | tftp, talk 등 불필요한 서비스 활성화 | ✅ | ✅ |
| U-47 | 서비스 관리 | Sendmail 버전 | Sendmail 최신 버전 패치 여부 | ✅ | ✅ |
| U-48 | 서비스 관리 | 스팸 메일 릴레이 | SMTP 릴레이 제한 설정 여부 | ✅ | ✅ |
| U-49 | 서비스 관리 | 일반사용자 Sendmail | 일반 사용자의 Sendmail 실행 방지 설정 | ✅ | ✅ |
| U-50 | 서비스 관리 | DNS 보안 버전 | BIND 최신 버전 사용 여부 | ✅ | ✅ |
| U-51 | 서비스 관리 | DNS Zone Transfer | DNS Zone Transfer 제한 설정 여부 | ✅ | ✅ |
| U-52 | 서비스 관리 | Apache 디렉터리 리스팅 | 디렉터리 인덱싱(Indexes) 제거 여부 | ✅ | ✅ |
| U-53 | 서비스 관리 | Apache 프로세스 권한 | 웹 서비스 데몬의 root 권한 구동 여부 | ✅ | ✅ |
| U-54 | 서비스 관리 | Apache 상위 디렉터리 | 상위 디렉터리 접근 제한(AllowOverride) | ✅ | ✅ |
| U-55 | 서비스 관리 | Apache 불필요 파일 | 매뉴얼 파일 등 불필요한 파일 제거 여부 | ✅ | ✅ |
| U-56 | 서비스 관리 | Apache 링크 사용금지 | 심볼릭 링크 사용 제한(FollowSymLinks) | ✅ | ✅ |
| U-57 | 서비스 관리 | Apache 파일 업로드 | 파일 업로드 용량 제한(LimitRequestBody) | ✅ | ✅ |
| U-58 | 서비스 관리 | Apache 영역 분리 | DocumentRoot 별도 디렉터리 지정 여부 | ✅ | ✅ |
| U-59 | 서비스 관리 | SSH 원격 접속 | SSH 서비스 활성화 및 포트 점검 | ✅ | ✅ |
| U-60 | 서비스 관리 | FTP 서비스 확인 | FTP 서비스 활성화 여부 | ✅ | ✅ |
| U-61 | 서비스 관리 | FTP 계정 Shell 제한 | FTP 계정에 쉘 부여 여부 | ✅ | ✅ |
| U-62 | 서비스 관리 | Ftpusers 파일 권한 | ftpusers 파일 소유자/권한 | ✅ | ✅ |
| U-63 | 서비스 관리 | Ftpusers 파일 설정 | root 계정 등 FTP 접속 제한 설정 | ✅ | ✅ |
| U-64 | 서비스 관리 | at 파일 권한 | at 접근 제어 파일(allow/deny) 권한 | ✅ | ✅ |
| U-65 | 서비스 관리 | SNMP 서비스 | SNMP 서비스 활성화 여부 | ✅ | ✅ |
| U-66 | 서비스 관리 | SNMP Community | Community String 복잡성(public 금지) | ✅ | ✅ |
| U-67 | 서비스 관리 | 로그온 배너 | 서버/Telnet/FTP/SMTP/DNS 로그인 배너 | ✅ | ✅ |
| U-68 | 서비스 관리 | NFS 설정파일 권한 | /etc/exports 파일 소유자/권한 | ✅ | ✅ |
| U-69 | 서비스 관리 | expn, vrfy 제한 | SMTP expn, vrfy 명령어 제한 설정 | ✅ | ✅ |
| U-70 | 서비스 관리 | Apache 정보 숨김 | 웹 서버 버전/OS 정보 노출 제한 | ✅ | ✅ |
| U-71 | 패치 관리 | 최신 보안 패치 | OS 및 주요 패키지 보안 패치 적용 여부 | ✅ | ✅ |
| U-72 | 로그 관리 | 로그 정기 검토 | 각종 로그의 정기적 검토 및 보고 체계 | ✅ | ✅ |
| U-73 | 로그 관리 | 시스템 로깅 설정 | syslog/rsyslog 로깅 정책 설정 여부 | ✅ | ✅ |

#### 3.6.3.2 Web Server (Nginx)

> **✅ 전체 6개 항목 조치 지원 (v0.4.17)**
> - 모든 항목 수동 가이드(Type C) - 상세 설정 변경 명령어 및 가이드 출력

| ID | 분류 | 항목명 | 상세 설명 | 진단 | 조치 |
|:---:|:---:|:---|:---|:---:|:---:|
| N-01 | 정보 노출 | 버전 정보 | HTTP 헤더/에러 페이지 내 버전 노출 여부 | ✅ | ✅ |
| N-02 | 접근 제어 | HTTP 메서드 | 불필요한 HTTP 메서드(PUT, DELETE 등) 허용 | ✅ | ✅ |
| N-03 | 접근 제어 | 디렉터리 리스팅 | 디렉터리 내 파일 목록 노출(Autoindex) | ✅ | ✅ |
| N-04 | 설정 관리 | 파일 업로드 | 업로드 파일 크기 제한 설정 여부 | ✅ | ✅ |
| N-05 | 접근 제어 | 파일 접근 | 숨겨진 파일/디렉터리 접근 허용 여부 | ✅ | ✅ |
| N-06 | 로그 관리 | 접근 로그 | Access Log 및 Error Log 활성화 여부 | ✅ | ✅ |

#### 3.6.3.3 Database (MariaDB)

> **✅ 전체 6개 항목 조치 지원 (v0.4.17)**
> - 모든 항목 수동 가이드(Type C) - 상세 설정 변경 명령어 및 가이드 출력

| ID | 분류 | 항목명 | 상세 설명 | 진단 | 조치 |
|:---:|:---:|:---|:---|:---:|:---:|
| D-01 | 계정 관리 | 기본 계정 | 불필요한 기본 계정(Anonymous) 및 테스트 DB | ✅ | ✅ |
| D-02 | 계정 관리 | Root 접근 | Root 계정의 원격 접속 허용 여부 | ✅ | ✅ |
| D-03 | 설정 관리 | 파일 권한 | 설정 파일 및 데이터 디렉터리 권한 | ✅ | ✅ |
| D-04 | 패스워드 | 복잡성 | 패스워드 복잡성 플러그인 활성화 여부 | ✅ | ✅ |
| D-05 | 네트워크 | 바인딩 주소 | 0.0.0.0 리스닝 (원격 접속 전체 허용) 여부 | ✅ | ✅ |
| D-06 | 로그 관리 | 감사 로그 | 에러 로그 및 감사 로그 활성화 여부 | ✅ | ✅ |

---

### 3.6.4 문제 해결

**Q. 조치 후 문제가 발생하여 원복하고 싶습니다.**
A. `fix` 명령어는 실행 시 항상 원본 파일의 백업(`*.bak`)을 생성합니다. 해당 파일을 원본으로 덮어쓰거나 수동으로 내용을 복구하세요.
예: `cp /etc/ssh/sshd_config.bak_20260118 /etc/ssh/sshd_config`
