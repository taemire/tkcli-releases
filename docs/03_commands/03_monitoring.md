## 3.3 모니터링 및 분석 (monitoring)


### 3.3.1 용량 확인 (size)


| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `(기본)` | MariaDB 상위 N개 테이블 용량 조회 | `[count]` : 출력 개수 (기본 20) |
| `tables` | MariaDB 테이블 용량 상세 조회 | `[count]` : 출력 개수<br/>`--by-month` : 월별 데이터 집계 보기 |
| `opensearch` | OpenSearch 인덱스 용량 조회 | `--by-month` : 월별 데이터 집계 보기 |


MariaDB 테이블 및 OpenSearch 인덱스의 용량을 확인합니다. `size tables`와 `size opensearch` 두 가지 하위 커맨드를 제공하며, 각각 상세한 정렬 및 집계 옵션을 지원합니다.

### 사용법

```bash
# 기본 사용 (MariaDB 상위 테이블 n개 확인)
tkcli size [n]

# MariaDB 테이블 상세 확인
tkcli size tables [n] [flags]

# OpenSearch 인덱스 상세 확인
tkcli size opensearch [flags]
```

### MariaDB 테이블 크기

```bash
# 전체 테이블
tkcli size tables

# 상위 20개 테이블
tkcli size tables 20

# 하위 호환성
tkcli size 20

# LOG 테이블 월별 데이터 집계
tkcli size tables --by-month
tkcli size db -m
```

**출력 예시:**

```
2025-12-24 21:03:53 [INFO] ### MariaDB 테이블 용량 확인 (00133FKFKG) ###
2025-12-24 21:03:53 [INFO] 🔎 상위 20 개 테이블을 표시합니다.

------------------------------------------------------------------------
 테이블명                                    크기          행 수       
------------------------------------------------------------------------
 TPU_ISTAT_MEDIA_EVENT_LOG                   19.3 MB       14,005      
 TPU_INFO_DEPLOYING_DETAIL                   960.0 KB      17          
 TPU_INFO_ENDPOINT_ISSUE_HISTORY             960.0 KB      15          
 TPU_ISTAT_SYS_LOG                           800.0 KB      213         
 TPU_INFO_SCHEDULE                           720.0 KB      15          
 TPU_ISTAT_UMS_HISTORY_SUM                   720.0 KB      15          
 TPU_ISTAT_MEDIA_BLOCK_SUM                   720.0 KB      15          
 TPU_ISTAT_EVENT_LOG                         704.0 KB      306         
 TPU_ISTAT_SYSTEM_SELF_TEST_LOG              592.0 KB      441         
 TPU_ISTAT_AGENT_INTEGRITY_LOG               528.0 KB      95          
------------------------------------------------------------------------
2025-12-24 21:03:53 [SUCC] 테이블 용량 조회 완료.
```

**출력 예시 (월별 집계):**

```
2026-01-13 23:21:10 [INFO] *_LOG 테이블 월별 데이터 집계 중...
2026-01-13 23:21:10 [INFO] 발견된 LOG 테이블: 44개

### TPU_ISTAT_MEDIA_EVENT_LOG (날짜 컬럼: client_dt)
----------------------------------
 MONTH            ROWS           
----------------------------------
 2026-01          53,922         
 2025-12          30,653         
 2025-11          11,881         
----------------------------------

### TPU_ISTAT_EVENT_LOG (날짜 컬럼: client_dt)
----------------------------------
 MONTH            ROWS           
----------------------------------
 2026-01          423            
 2025-12          595            
 2025-11          164            
----------------------------------
```

**주요 기능:**
- MySQL 스타일 테이블 형식 출력
- 자동 단위 변환 (B/KB/MB/GB)
- 천 단위 콤마 표시 (14,005)
- 크기 기준 내림차순 정렬
- 동적 컬럼 너비 조정
- **월별 집계 옵션** (`-m`, `--by-month`): `*_LOG` 테이블의 날짜 컬럼을 자동 감지하여 월별 데이터 집계


### OpenSearch 인덱스 크기

```bash
# 전체 인덱스 목록
tkcli size opensearch

# 월별 집계 (날짜 패턴 인덱스)
tkcli size opensearch -m
tkcli size opensearch --by-month
```

**출력 예시 (일반):** 

```
2025-12-08 15:17:47[INFO] OpenSearch Disk Usage Check...

------------------------------------------------------------------------
 인덱스 (INDEX)                              크기          문서 수     
------------------------------------------------------------------------
 00133fkfkg_2025_11                          7.2 MB        12,486      
 00133fkfkg_2025_12                          3.4 MB        4,713       
 top_queries-2025.12.07-15367                507.1 KB      199         
 top_queries-2025.12.05-15365                481.5 KB      293         
 ...
------------------------------------------------------------------------
2025-12-08 15:17:47[SUCC] Check Complete.
```

**출력 예시 (월별 집계):**

```
------------------------------------------------------------------------
 월 (MONTH)                                  크기          문서 수     
------------------------------------------------------------------------
 00133fkfkg_2025-11                          7.2 MB        12,486      
 00133fkfkg_2025-12                          3.4 MB        4,713       
 2025-12                                     2.1 MB        1,795       
------------------------------------------------------------------------
```

**주요 기능:**
- MariaDB와 동일한 MySQL 스타일 테이블 형식
- 자동 단위 변환 및 천 단위 콤마
- 크기 기준 내림차순 정렬
- 월별 집계 옵션 (`-m`, `--by-month`)

---

### 3.3.2 로그 분석 (analyze)


| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `recommend` | 데이터 기반 분석 추천 | `--month` : 분석 대상 월 (YYYY-MM) |
| `media-top` | 매체제어 프로세스/경로 Top N | `--month` : 대상 월<br/>`--limit` : 출력 개수 (기본 20)<br/>`--output` : CSV 파일로 저장 |
| `agent-anomaly` | 과도한 로깅 에이전트 탐지 | `--month` : 대상 월<br/>`--threshold` : 평균 대비 임계 배수 (기본 5.0) |
| `process-top` | 프로세스별 로그 집계 | `--month` : 대상 월<br/>`--limit` : 출력 개수 |
| `db-trend` | DB 데이터 증가 추세 분석 | `--output` : CSV 파일로 저장 |


MariaDB 및 OpenSearch의 로그 데이터를 분석하여 원인 진단 및 이상 탐지를 수행합니다. 운영 환경에서 로그 급증의 원인을 파악하고, 분석이 필요한 항목을 자동으로 추천받을 수 있습니다.

### 사용법

```bash
tkcli analyze [subcommand] [flags]
```

### 서브커맨드

| 서브커맨드 | 설명 | 데이터 소스 |
| :--- | :--- | :--- |
| `media-top` | 매체제어 프로세스+경로별 Top N 분석 | OpenSearch |
| `agent-anomaly` | 과도한 로깅 에이전트 탐지 | OpenSearch |
| `process-top` | 프로세스별 로그 집계 Top N | OpenSearch |
| `recommend` | 데이터 기반 분석 추천 | MariaDB + OpenSearch |
| `db-trend` | DB 데이터 증가 추세 분석 | MariaDB |

### 공통 플래그

| 플래그 | 축약 | 설명 | 기본값 |
| :--- | :--- | :--- | :--- |
| `--month` | `-m` | 분석 대상 월 (YYYY-MM) | 현재 월 |
| `--limit` | `-n` | 결과 개수 제한 | 20 |
| `--timeout` | | 쿼리 타임아웃 (초) | 30 |
| `--output` | `-o` | 결과 저장 파일 경로 (.csv, .txt) | (화면 출력) |

---

### 분석 추천 (recommend)

데이터 상태를 자동 진단하여 어떤 분석을 수행해야 할지 권장 명령을 추천합니다. 운영자가 "무엇을 분석해야 하나요?"라는 질문에 자동으로 답변을 제공합니다.

**사용법:**
```bash
# 기본 실행 (현재 월 기준)
tkcli analyze recommend

# 특정 월 기준 분석
tkcli analyze recommend --month 2026-01
```

**출력 예시:**
```
📊 데이터 분석 권장 리포트
═══════════════════════════════════════════════════════════════════════════════
  기준 월: 2026-01

═══════════════════════════════════════════════════════════════════════════════
📈 [1] 매체제어 로그
───────────────────────────────────────────────────────────────────────────────
   테이블: TPU_ISTAT_MEDIA_EVENT_LOG
   현재 월: 55941건  |  전월: 28970건  |  증가율: +93.1%

   ⚠️ 전월 대비 93% 증가 - 원인 분석 권장

   → 권장 명령:
     tkcli analyze media-top --month 2026-01
═══════════════════════════════════════════════════════════════════════════════
📈 [2] 이벤트 로그
───────────────────────────────────────────────────────────────────────────────
   테이블: TPU_ISTAT_EVENT_LOG
   현재 월: 503건  |  전월: 566건  |  증가율: -11.1%

   ✅ 정상 범위 내 변동
═══════════════════════════════════════════════════════════════════════════════

🔍 요약: 1개 항목 분석 권장, 2개 정상
```

**판정 기준:**
- **🔴 폭증 (Priority 1)**: 전월 대비 100% 이상 증가 → 즉시 분석 필요
- **⚠️ 급증 (Priority 2)**: 전월 대비 50~100% 증가 → 원인 분석 권장
- **✅ 정상 (Priority 3)**: 전월 대비 50% 미만 변동

---

### 매체제어 로그 분석 (media-top)

매체제어 이벤트 로그에서 프로세스+경로 조합별 발생 빈도 Top N을 분석합니다. 어떤 프로세스가 어떤 경로에 가장 많이 접근했는지 파악할 수 있습니다.

**사용법:**
```bash
# 현재 월 상위 10개
tkcli analyze media-top --limit 10

# 특정 월 분석
tkcli analyze media-top --month 2026-01

# 결과를 CSV 파일로 저장
tkcli analyze media-top --month 2026-01 --output media_report.csv
```

**출력 예시:**
```
2026-01-15 17:51:59 [INFO] 매체제어 로그 분석 (media-top)
2026-01-15 17:51:59 [INFO]   기간: 2026-01-01 ~ 2026-02-01
2026-01-15 17:51:59 [INFO]   소스: opensearch
2026-01-15 17:51:59 [INFO]   제한: 5건

----------------------------------------------------------------------------------
 RANK    PROCESS                                         PATH                  COUNT
----------------------------------------------------------------------------------
 1       C:\Windows\Explorer.EXE                                               42,349
 2       C:\Windows\system32\svchost.exe                                       5,966
 3       C:\Program Files\...\MsMpEng.exe               E:\                   2,611
 4                                                                             1,019
 5       C:\Windows\System32\powershell.exe             \RaiDrive\MyDS\       811
----------------------------------------------------------------------------------
  총 5건 출력
```

---

### 에이전트 이상 탐지 (agent-anomaly)

평균 대비 과도하게 로깅하는 에이전트를 탐지합니다. 특정 PC에서 비정상적인 이벤트가 다량 발생하는 경우를 식별할 수 있습니다.

**사용법:**
```bash
# 기본 실행 (평균 대비 5배 이상 탐지)
tkcli analyze agent-anomaly

# 임계치 조정 (평균 대비 10배 이상만 탐지)
tkcli analyze agent-anomaly --threshold 10

# 특정 월 분석
tkcli analyze agent-anomaly --month 2026-01
```

**출력 예시:**
```
2026-01-15 17:52:01 [INFO] 에이전트 이상 로깅 탐지 (agent-anomaly)
2026-01-15 17:52:01 [INFO]   기간: 2026-01-01 ~ 2026-02-01
2026-01-15 17:52:01 [INFO]   소스: opensearch
2026-01-15 17:52:01 [INFO]   임계치: 평균 x5.0 이상

--------------------------------------------
  📊 에이전트 로깅 통계
--------------------------------------------
  총 에이전트 수: 150
  평균 로깅 건수: 352.1
  표준 편차: 1,245.3
  이상 에이전트: 3개 (임계치: 평균 x5.0 이상)
--------------------------------------------

----------------------------------------------------------------------
 RANK    AGENT_ID(PUID)                       COUNT         RATIO
----------------------------------------------------------------------
 1       a1b2c3d4-e5f6-7890-...               15,234        43.3x 🔴
 2       b2c3d4e5-f6a7-8901-...               8,456         24.0x 🔴
 3       c3d4e5f6-a7b8-9012-...               2,108         6.0x ⚠️
----------------------------------------------------------------------
```

**판정 기준:**
- **🔴 심각**: 평균 대비 10배 이상 로깅
- **⚠️ 주의**: 평균 대비 5~10배 로깅

---

### 프로세스 집계 분석 (process-top)

프로세스별 로그 발생 건수를 집계하여 상위 N개를 표시합니다. 어떤 프로세스가 가장 많은 이벤트를 발생시키는지 파악할 수 있습니다.

**사용법:**
```bash
# 상위 20개 프로세스
tkcli analyze process-top

# 상위 5개만 표시
tkcli analyze process-top --limit 5

# 특정 월 분석 및 파일 저장
tkcli analyze process-top --month 2026-01 --output process.csv
```

**출력 예시:**
```
2026-01-15 17:52:03 [INFO] 프로세스별 로그 집계 (process-top)
2026-01-15 17:52:03 [INFO]   기간: 2026-01-01 ~ 2026-02-01
2026-01-15 17:52:03 [INFO]   소스: opensearch
2026-01-15 17:52:03 [INFO]   제한: 5건

-----------------------------------------------------------------------------------------------------------------
 RANK    PROCESS                                                                        COUNT         RATIO
-----------------------------------------------------------------------------------------------------------------
 1       C:\Windows\Explorer.EXE                                                        42,349        80.3%
 2       C:\Windows\system32\svchost.exe                                                5,966         11.3%
 3       C:\ProgramData\Microsoft\Windows Defender\...\MsMpEng.exe                      2,611         4.9%
 4                                                                                      1,019         1.9%
 5       C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe                      811           1.5%
-----------------------------------------------------------------------------------------------------------------
  총 5건 출력 (전체 집계 합계: 52,756건)
```

---

### DB 증가 추세 분석 (db-trend)

DB 및 로그 데이터의 증가 추세를 분석하여 스토리지 용량 계획(Capacity Planning)을 지원합니다.
**Fast Mode(기본)**와 **Precise Mode(정밀)** 두 가지 모드를 제공합니다.

**사용법:**
```bash
# 기본 실행 (Fast Mode: information_schema 기반 즉시 분석)
tkcli analyze db-trend

# 정밀 분석 (Precise Mode: COUNT(*) 쿼리 기반 상세 분석, 시간 소요됨)
tkcli analyze db-trend --precise
tkcli analyze db-trend -P

# 결과를 CSV 파일로 저장
tkcli analyze db-trend --output trend.csv
```

---

#### 1. Fast Mode (기본)
`information_schema` 메타데이터를 사용하여 **즉시(O(1))** 결과를 반환합니다. 운영 중인 DB에 부하를 주지 않으며, 전체 시스템(MariaDB + OpenSearch + Disk)의 용량 현황을 통합 리포트로 제공합니다.

**출력 예시:**
```
2026-01-19 22:36:07 [INFO] DB 데이터 증가 추세 분석 (db-trend)
2026-01-19 22:36:07 [INFO] ⚡ 빠른 분석 모드 (information_schema 기반)

═══════════════════════════════════════════════════════════════════════════════
📊 시스템 용량 현황 리포트 (Fast Mode)
───────────────────────────────────────────────────────────────────────────────
 📁 MariaDB 크기  : 138.29 MB (디스크 점유율 0.1%)
 📁 OpenSearch    : 57.80 MB
 📁 설치 디렉토리 : 71.07 GB (/usr/local/TACHYON/TTS40)
───────────────────────────────────────────────────────────────────────────────
 💾 디스크 가용량  : 27.86 GB (전체 98.93 GB 중 사용 71.8%)
───────────────────────────────────────────────────────────────────────────────
 📈 월간 예상 증가 : 16.30 MB / 월 (MariaDB: 10.52 MB + OpenSearch: 5.78 MB)
 📈 년간 예상 증가 : 195.59 MB / 년
 📅 디스크 포화 예측: 🟢 약 1750.6개월 후 포화 예상 (2171-11-19)
 📋 분석 테이블 수 : 50개
═══════════════════════════════════════════════════════════════════════════════

📋 테이블 현황 (전체 50개 중 상위 10개)
-------------------------------------------------------------------------------------------
 #     TABLE                                ROWS (추정)         SIZE          AVG_ROW     
-------------------------------------------------------------------------------------------
 1     TPU_ISTAT_MEDIA_EVENT_LOG            76,989              91.19 MB      1.21 KB     
 2     TPU_ISTAT_EVENT_LOG                  1,079               1.02 MB       986 B       
 3     TPU_ISTAT_AGENT_INTEGRITY_LOG        528                 592.00 KB     1.12 KB     
 ...
 10    TPU_ISTAT_SUSB_INTEGRITY_LOG         16                  256.00 KB     16.00 KB    
 ...   외 40개 테이블                       2,182               9.81 MB       -           
-------------------------------------------------------------------------------------------
```

**주요 기능:**
1.  **통합 용량 리포트**: MariaDB, OpenSearch, 설치 디렉토리, 디스크 가용량을 한눈에 파악
2.  **Capacity Planning**: 현재 데이터 크기를 기반으로 월간/년간 증가량 추정 및 디스크 포화 시점 예측
3.  **대용량 테이블 Top 50**: 용량 순 상위 10개 테이블 상세 표시 및 나머지 요약

---

#### 2. Precise Mode (정밀 분석)
`--precise` 또는 `-P` 옵션 사용 시 동작합니다. 실제 `COUNT(*)` 쿼리를 수행하여 정확한 행 수와 기간별(1주, 1개월, 1분기, 1년) 증가 추세를 분석합니다. 대용량 DB의 경우 시간이 소요될 수 있습니다.

**출력 예시:**
```
2026-01-17 20:21:17 [INFO] 🔍 정밀 분석 모드 (COUNT 쿼리 사용, 시간 소요)
...
📊 DB 용량 계획 리포트 (Capacity Planning)
...
-------------------------------------------------------------------------------------------------------------------
 TABLE                 PERIOD           START(ACC)    END(ACC)      INCREASE      RATE        TREND
-------------------------------------------------------------------------------------------------------------------
 STAT_MEDIA_EVENT_LOG  최근 1주         71,499        96,792        25,293        +35.4%      🟠 급증 (주의)
 STAT_MEDIA_EVENT_LOG  최근 1개월       16,268        96,792        80,524        +495.0%     🔴 폭증 (위험)
 ...
```

**주요 기능:**
1.  **정확한 데이터**: InnoDB 추정치가 아닌 실제 Row Count 기반
2.  **기간별 추세**: 1주/1개월/1분기/1년 전 데이터와 비교하여 정확한 증가율(%) 산출
3.  **위험도 진단**: 증가율에 따른 트렌드 진단 (🔴 폭증, 🟠 급증 등)
