## 3.1 기본 시스템 관리


이 섹션에서는 시스템 전반의 상태를 확인하고 유지보수하는 기본 명령어(`version`, `info`, `admin`, `completion`, `update`)를 다룹니다.

---

### 3.1.1 버전 정보 (version)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `(기본)` | 시스템 및 컴포넌트 버전 상세 조회 | 없음 |


TKCLI 및 관련 미들웨어의 버전 정보를 확인합니다. 모든 TACHYON 컴포넌트와 미들웨어의 상세 버전을 테이블 형식으로 제공하며, `--help`를 통해 상세 설명을 확인할 수 있습니다.

### 사용법

```bash
tkcli version [flags]
```

### 출력 예시

```
2025-12-25 21:02:15 [INFO] ### TACHYON 서비스 버전 확인 ###
tkcli 버전: 0.3.30

--- Tachyon 엔진 ---
---------------------------------------------------------------------
 컴포넌트                   버전                                    
---------------------------------------------------------------------
 MariaDB                    10.11.2                                 
 NGINX                      1.29.4                                  
 Redis                      8.4.0                                   
 Kafka                      3.4.0                                   
 Zookeeper                  3.6.3                                   
 OpenSearch                 2.19.4                                  
 OpenSearch Dashboards      2.8.0                                   
 Logstash                   8.6.1                                   
---------------------------------------------------------------------

리비전 = 4.0.0.314
----------------------------------------------------------------------------
 컴포넌트              패치 버전             JAR 버전                      
----------------------------------------------------------------------------
 Front                 1.1.59.1              V4.0.0.1-20251104             
 API                   1.1.50                V4.0.0.1-20251027             
 Auth                  1.1.3                 V4.0.0.1-20250915             
 ...
----------------------------------------------------------------------------
2025-12-24 21:02:15 [SUCC] 버전 확인 완료.
```

---

### 3.1.2 시스템 정보 (info)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `(기본)` | 시스템 리소스 및 디스크 사용량 조회 | 없음 |


라이선스 정보, 시스템 리소스, 디스크 사용량, 서비스 상태를 한눈에 확인합니다. 상세 정보는 `/usr/local/TACHYON` 경로 및 관련 미들웨어 데이터를 자동으로 수집하여 표시합니다.

### 사용법

```bash
tkcli info [flags]
```

### 출력 예시

```
2025-12-24 21:02:27 [INFO] ### TACHYON 시스템 정보 ###
--- 라이선스 및 기업 정보 ---
------------------------------------------------------
 자산 항목             값                            
------------------------------------------------------
 설치 기관명           TSGroup -오프라인             
 기관 코드             00133FKFKG                    
 에이전트 수           100                           
------------------------------------------------------

--- 시스템 리소스 ---
---------------------------------------
 리소스                사용량         
---------------------------------------
 전체 물리 메모리      15 GB          
 여유 메모리           0 GB           
---------------------------------------

--- 디스크 사용량 ---
------------------------------------------------------------------------------------------------
 분류                            크기        경로                                              
------------------------------------------------------------------------------------------------
 설치 디렉토리                   7.7G        /usr/local/TACHYON
 데이터베이스                    2.1G        /usr/local/TACHYON/TTS40/mariadb/data
 OpenSearch                      15G         /usr/local/TACHYON/TTS40/opensearch/opensearch/data
------------------------------------------------------------------------------------------------

2025-12-24 21:02:28 [SUCC] 서비스 상태 확인 완료.
```

> **참고: OS 메모리 과점유 현황 안내**
> `tkcli info`에서 리포팅되는 메모리 사용량은 운영체제 레벨의 물리적 점유 현황을 포함합니다. 특히 Linux 환경에서는 성능 최적화를 위해 유휴 메모리를 **Page Cache/Buffer**로 활용하므로, 실제 프로세스가 사용하는 양보다 높게 표시되는 '과점유' 현상이 발생할 수 있습니다. 이는 시스템 장애가 아닌 정상적인 운영체제 성능 관리의 결과이며, 상세 기술 설명은 **[부록 A - 8. OS 메모리 관리 명세]**를 참조하십시오.

---

### 3.1.3 관리자 비밀번호 재설정 (admin)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `(기본)` | 관리자 비밀번호 초기화 | `[user_id]` : 대상 사용자 ID (기본: admin) |


관리자 계정의 비밀번호를 초기화합니다.

### 사용법

```bash
tkcli admin <USER_ID>
```

### 초기화 비밀번호

`!TumsAdmin2025`

### 예제

```
# admin 계정 비밀번호 재설정
tkcli admin admin

# 특정 사용자 비밀번호 재설정
tkcli admin user123
```

### 출력 예시

```
2025-12-07 16:15:00[INFO] 사용자 ID 'admin'의 비밀번호를 업데이트합니다...
2025-12-07 16:15:01[SUCC] 사용자 'admin'의 비밀번호 업데이트를 완료했습니다.
2025-12-07 16:15:01[INFO] 새로운 비밀번호와 키가 설정되었습니다.
```

---

### 3.1.4 자동 완성 (completion)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `(기본)` | 쉘 자동 완성 스크립트 생성 | `[bash/zsh/fish/powershell]` |


다양한 셸에 대한 자동 완성 스크립트를 생성합니다.

### 지원 셸

- Bash
- Zsh
- Fish

### 사용법

```bash
tkcli completion [bash|zsh|fish|powershell]
```

### 설치 방법

**Bash (Linux):**

```bash
# 시스템 전역
tkcli completion bash | sudo tee /etc/bash_completion.d/tkcli

# 사용자별
tkcli completion bash > ~/.local/share/bash-completion/completions/tkcli
```

**Zsh:**

```bash
# Completion 활성화 (처음 한 번만)
echo "autoload -U compinit; compinit" >> ~/.zshrc

# Completion 스크립트 설치
tkcli completion zsh > "${fpath[1]}/_tkcli"
```

**Fish:**

```bash
tkcli completion fish > ~/.config/fish/completions/tkcli.fish
```

### v0.4.20+ Tab Completion 기능 강화

v0.4.20부터 모든 파일 경로 완성이 비활성화되고, 지능형 자동 완성 기능이 대폭 강화되었습니다.

**정적 완성 (Static Completion):**

적용된 플래그에 대해 사전 정의된 값을 즉시 제안합니다.

| 플래그 | 적용 명령어 | 완성 값 |
|:---|:---|:---|
| `--format` | `analyze`, `backup` | `json`, `csv`, `table` |
| `--level` | 전역 | `debug`, `info`, `warn`, `error` |
| `--target` | `service`, `fix` | `all`, `tachyon`, `middleware` |
| `--shell` | `completion` | `bash`, `zsh`, `fish` |
| `--status` | `analyze security` | `vulnerable`, `good`, `manual` |
| `--source` | `analyze` | `opensearch`, `mariadb`, `filesystem` |

**동적 완성 (Dynamic Completion):**

OpenSearch 연결을 통해 실시간으로 인덱스/필드 목록을 조회하여 제안합니다.

| 플래그 | 적용 명령어 | 동작 |
|:---|:---|:---|
| `--index` | `backup opensearch`, `analyze` | 실시간 인덱스 목록 조회 |
| `--field` | `analyze media-top` 등 | 선택된 인덱스의 필드 목록 조회 |
| `--pattern` | `backup opensearch ilm` | 인덱스 패턴 제안 |
| `--policy` | `backup opensearch ilm` | ILM 정책 목록 조회 |
| `--alias` | `backup opensearch` | 별칭 목록 조회 |

**사용 예시:**
```bash
# 정적 완성
tkcli analyze --format <Tab>
# json  csv  table

# 동적 완성 (OpenSearch 연결 필요)
tkcli backup opensearch index --index <Tab>
# tachyon-agent-2026.01  tachyon-media-2026.01  ...
```

---

### 3.1.5 서비스 업데이트 (update)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `nginx` | Nginx 업데이트 | `-f` : 패키지 파일 경로 (필수)<br/>`--force` : 버전 체크 무시 강제 진행 |
| `redis` | Redis 업데이트 | `-f` : 패키지 파일 경로 (필수) |
| `opensearch` | OpenSearch 업데이트 | `-f` : 패키지 파일 경로 (필수)<br/>`--force` : 버전 체크 무시 강제 진행 |


TACHYON 시스템의 주요 미들웨어 서비스(Nginx, Redis, OpenSearch)를 업데이트합니다.
단순한 파일 교체가 아닌, **버전 검증 시스템**이 내장되어 있어 잘못된 버전 설치로 인한 시스템 장애를 방지합니다.

### 사용법

```bash
tkcli update [service] [flags]
```

### 옵션

- `--file`, `-f`: 업데이트할 패키지 파일(`.tar.gz`)의 경로를 지정합니다.
- `--force`: 버전 안전성 체크를 무시하고 강제로 업데이트를 진행합니다. (Downgrade 환경에서 유용)

### 안전 장치 (Safety Guard)

1. **다운그레이드 차단**: 설치하려는 패키지의 버전이 현재 시스템에 설치된 버전보다 낮을 경우 업데이트를 자동으로 중단합니다.
2. **메이저 버전 보호**: 버전의 첫 번째 숫자(Major)가 다를 경우(예: v2 -> v3) 경고를 출력하여 호환성 문제를 사전에 인지시킵니다.
3. **무결성 검사**: 압축 해제 후 바이너리를 직접 실행하여 버전 정보를 추출하고 검증합니다.

### 예제 (상세 로그)

```bash
$ tkcli update nginx -f nginx-1.29.4.tar.gz

2024-12-21 15:30:10 [INFO] nginx 업데이트 시작...
2024-12-21 15:30:10 [INFO] 버전 검증: 현재 1.29.3 -> 대상 1.29.4 (안전)
...
2024-12-21 15:30:15 [SUCC] nginx 업데이트가 완료되었습니다.
```

---

### 3.1.6 업데이트 패키지 생성 (update package) [DEPRECATED]

운영 환경(폐쇄망 등)에 배포할 미들웨어 패키지를 생성합니다. 인터넷이 연결된 환경에서 최신 소스를 다운로드하고, 운영 서버 사양에 맞춰 바이너리를 컴파일 및 재포장합니다.

### 사용법

```bash
tkcli update package [service]
```

### 지원 서비스

- `nginx`: 최신 안정 버전 소스 다운로드 및 OpenSSL/PCRE2/Zlib 정적 컴파일 포함.
- `redis`: 최신 소스 다운로드 및 컴파일.
- `opensearch`: 공식 바이너리 기반 재포장.
- `mariadb`: MariaDB REST API 기반 바이너리 tarball 다운로드 (LTS 10.11 기본). REST API 실패 시 `archive.mariadb.org` 폴백 지원.

### 빌드 의존성 자동 확인 (Build Dependency Guard)

패키징 작업 전, 시스템에 필수 빌드 도구가 있는지 자동으로 검사합니다.

1. **검사항목**: `gcc`, `make`, `perl` (FindBin 모듈 포함), `tar`, `curl`
2. **자동 설치**: root 권한이 있는 경우, 누락된 도구를 `dnf` 또는 `apt`를 통해 자동으로 설치합니다.
3. **수동 설치 안내**: 권한이 없거나 자동 설치가 불가능한 경우, 해당 시스템에 최적화된 설치 명령어를 화면에 안내합니다.

```bash
$ tkcli update package nginx

2025-12-23 11:00:05 [INFO] 빌드 의존성 확인 중...
2025-12-23 11:00:05 [WARN] 누락된 의존성 발견: gcc, perl
2025-12-23 11:00:05 [INFO] 필수 패키지를 자동으로 설치합니다...
...
2025-12-23 11:02:40 [SUCC] 빌드 의존성 설치 완료. 패키징을 계속합니다.
```
**정상적인 업그레이드 상황**
```bash
$ tkcli update opensearch --file opensearch-2.19.4.tar.gz
```
**출력 결과:**
```bash
2025-12-20 12:16:34[INFO] 대상 서비스: opensearch, 파일: /root/packages/opensearch-2.19.4.tar.gz
2025-12-20 12:16:34[INFO] OpenSearch 업데이트를 시작합니다 (원본: /root/packages/opensearch-2.19.4.tar.gz)
2025-12-20 12:16:34[INFO] opensearch 서비스를 중지하는 중...
2025-12-20 12:16:34[INFO] 압축 해제 중...
2025-12-20 12:16:49[INFO] 버전 확인: [현재: 2.18.0] -> [신규: 2.19.4]
2025-12-20 12:16:49[SUCC] 버전 업그레이드 확인: 2.18.0 -> 2.19.4
2025-12-20 12:16:49[INFO] 파일 동기화 중(rsync)...
2025-12-20 12:16:53[INFO] opensearch 서비스를 시작하는 중...
2025-12-20 12:16:54[SUCC] OpenSearch 업데이트를 성공적으로 마쳤습니다.
```

```bash
# 강제 복구(Downgrade)가 필요한 상황
tkcli update opensearch --file opensearch-2.19.4.tar.gz --force

# 출력 결과:
2025-12-20 12:24:49[INFO] 버전 확인: [현재: 3.4.0] -> [신규: 2.19.4]
2025-12-20 12:24:49[WARN] 치명적: 메이저 버전 불일치! 호환성 문제가 발생할 수 있습니다.
2025-12-20 12:24:49[WARN] --force 플래그에 의해 안전 검사를 건너뜜니다. 이전 버전으로 진행합니다 (2.19.4 < 3.4.0).
2025-12-20 12:24:49[INFO] 파일 동기화 중(rsync)...
2025-12-20 12:24:54[SUCC] OpenSearch 업데이트를 성공적으로 마쳤습니다.
```

### 3.1.7 배포용 패키지 생성 (update package)

| 명령어 | 기능 | 주요 플래그 (옵션) |
|:---|:---|:---|
| `nginx` | Nginx 패키지 생성 | `--version`, `--clean-cache` |
| `redis` | Redis 패키지 생성 | `--version`, `--clean-cache` |
| `opensearch` | OpenSearch 패키지 다운로드 | `--version`, `--clean-cache` |
| `mariadb` | MariaDB 패키지 다운로드 | `--version`, `--clean-cache` |

### 플래그

| 플래그 | 단축 | 설명 |
|:---|:---|:---|
| `--version` | `-V` | 특정 버전 지정 (예: `--version 10.11.11`) |
| `--clean-cache` | - | 캐시 디렉토리 정리 후 빌드 |


전문 엔지니어가 폐쇄망 환경 배포를 위해 최신 버전의 미들웨어를 다운로드, 컴파일 및 패키징하는 전문 기능을 제공합니다. 이 기능은 운영 환경의 **호환성을 유지**하기 위해 현재 설치된 메이저 버전을 추적합니다.

### 특징

- **메이저 버전 보호**: 현재 v1.x를 사용 중이라면 v2.x가 출시되어도 v1.x 계열의 최신 패치 버전을 자동으로 찾아 패키징합니다.
- **의존성 자동 해결**: Nginx 빌드 시 필요한 PCRE2, OpenSSL, Zlib 등의 라이브러리를 소스와 함께 자동으로 다운로드하여 정적 빌드합니다.
- **표준화된 파일명**: `nginx-1.29.4.tar.gz`와 같이 버전이 명시된 파일명으로 패키지를 생성합니다.

### 예제

```bash
# Nginx 최신 패치 패키지 생성
tkcli update package nginx

# 출력 결과:
2025-12-20 12:12:40[INFO] 인터넷 연결 확인 중...
2025-12-20 12:12:41[SUCC] 인터넷 연결이 확인되었습니다.
2025-12-20 12:12:41[INFO] 현재 설치된 버전: 1.29.3 (메이저: 1)
2025-12-20 12:12:41[INFO] nginx의 최신 안정 버전을 감지하는 중 (메이저 1 필터링)...
2025-12-20 12:12:42[INFO] 대상 버전(1.29.4)이 현재(1.29.3)보다 최신입니다. 패키지 업데이트를 권장합니다.
2025-12-20 12:12:43[INFO]   - 의존성 다운로드 중: pcre2-10.45
2025-12-20 12:12:48[INFO]   - 설정 중 (configure): --with-pcre=../pcre2-10.45 ...
2025-12-20 12:12:53[INFO]   - 컴파일 중...
2025-12-20 12:14:25[SUCC] 패키지가 성공적으로 생성되었습니다: /root/dist/packages/nginx-1.29.4.tar.gz
```

```bash
# MariaDB 최신 LTS 패키지 생성 (버전 미지정 시 자동 감지)
tkcli update package mariadb

# 출력 결과:
2026-02-09 16:59:51[INFO] 인터넷 연결 확인 중...
2026-02-09 16:59:52[SUCC] 인터넷 연결이 확인되었습니다.
2026-02-09 16:59:52[INFO] 현재 설치된 버전: 10.11.2 (메이저: 10.11)
2026-02-09 16:59:52[INFO] mariadb의 최신 안정 버전을 감지하는 중 (메이저 10.11 필터링)...
2026-02-09 16:59:52[INFO] MariaDB 10.11 시리즈 최신 버전 탐지 중...
2026-02-09 16:59:54[INFO] 대상 버전(10.11.16)이 현재(10.11.2)보다 최신입니다. 패키지 업데이트를 권장합니다.
2026-02-09 16:59:54[INFO] mariadb 10.11.16 소스/아티팩트 다운로드 중...
2026-02-09 17:01:12[INFO] mariadb 10.11.16 빌드 및 패키지 생성 중...
2026-02-09 17:01:20[SUCC] 패키지가 성공적으로 생성되었습니다: /root/dist/packages/mariadb-10.11.16.tar.gz
```

> **버전 자동 감지 (v0.5.7)**: 버전을 지정하지 않으면 현재 설치된 MariaDB의 메이저 시리즈(예: 10.11)를 자동 추출하고, REST API(`downloads.mariadb.org`) 또는 아카이브(`archive.mariadb.org`) 폴백을 통해 최신 패치 버전을 감지합니다.

```bash
# 특정 버전 지정 (--version 플래그)
tkcli update package mariadb --version 10.11.10
tkcli update package nginx -V 1.24.0

# 전체 서비스 패키지 생성
tkcli update package all
```

### 참고 사항

- 이 명령어는 **인터넷 연결이 활성화**된 환경(예: 개발 서버, 인터넷 가능 운영 서버)에서 실행해야 합니다.
- 생성된 패키지는 폐쇄망 서버로 복사한 후 `tkcli update` 명령어를 통해 설치할 수 있습니다.

### 빌드 환경 요구사항

Nginx와 Redis 패키지 생성에는 **소스 코드 컴파일**이 필요하므로 다음 빌드 도구가 시스템에 설치되어 있어야 합니다:

| 구성 요소 | 설명 | RHEL/Rocky/Alma 패키지 | Ubuntu/Debian 패키지 |
| :--- | :--- | :--- | :--- |
| **GCC** | C/C++ 컴파일러 | `gcc`, `gcc-c++` | `build-essential` |
| **Make** | 빌드 자동화 도구 | `make` | `make` |
| **Perl** | OpenSSL 빌드에 필요 | `perl-core`, `perl-IPC-Cmd` | `perl` |
| **Tar** | 아카이브 처리 | `tar` | `tar` |

> **참고**: OpenSearch와 MariaDB는 사전 빌드된 바이너리를 다운로드하므로 컴파일 도구가 필요하지 않습니다.

### 의존성 자동 설치

`tkcli`는 패키징 시작 전에 빌드 의존성을 자동으로 확인하고, 누락된 패키지가 있을 경우 **자동으로 설치를 시도**합니다.

**동작 방식:**
1. OS 배포판(RHEL, Rocky, Ubuntu 등)을 자동 감지합니다.
2. 패키지 관리자(dnf, yum, apt)를 확인합니다.
3. root 권한으로 실행 중일 경우, 누락된 패키지를 자동 설치합니다.
4. 자동 설치가 불가능할 경우, 수동 설치 명령어를 안내합니다.

**출력 예시 (의존성 자동 설치):**
```
2025-12-23 17:00:00[INFO] 빌드 의존성 확인 중...
2025-12-23 17:00:00[WARN] 누락된 빌드 의존성: gcc, perl
2025-12-23 17:00:00[INFO] 누락된 패키지를 자동으로 설치합니다...
2025-12-23 17:00:00[INFO] dnf 명령어로 패키지를 설치합니다: gcc, gcc-c++, perl-core, perl-IPC-Cmd
...
2025-12-23 17:00:15[SUCC] 빌드 의존성 설치가 완료되었습니다.
```

**수동 설치 (자동 설치 실패 시):**

```bash
# RHEL 9 / Rocky Linux 9 / AlmaLinux 9
sudo dnf install -y gcc gcc-c++ make perl-core perl-IPC-Cmd

# Ubuntu / Debian
sudo apt-get install -y build-essential make perl
```
